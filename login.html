<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Login — Loja Exemplo</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#071024;color:#e6eef8;padding:24px}
    .card{background:#0b1220;padding:18px;border-radius:8px;max-width:420px}
    .btn{background:#06b6d4;border:none;padding:8px 12px;border-radius:6px;color:#061226;cursor:pointer}
    label{display:block;margin-top:8px;font-size:14px}
    input{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;background:transparent;color:inherit}
  </style>
</head>
<body>

  <h1>Entrar / Cadastrar</h1>

  <div class="card">
    <h3>Login</h3>
    <form id="loginForm">
      <label>Email</label>
      <input id="loginEmail" type="email" required>
      <label>Senha</label>
      <input id="loginPassword" type="password" required>
      <div style="margin-top:12px">
        <button class="btn" type="submit">Entrar</button>
      </div>
    </form>

    <hr style="margin:16px 0">

    <h3>Cadastrar</h3>
    <form id="signupForm">
      <label>Nome</label>
      <input id="signupNome" type="text" required>
      <label>Data de nascimento</label>
      <input id="signupNascimento" type="date" required>
      <label>Email</label>
      <input id="signupEmail" type="email" required>
      <label>Senha</label>
      <input id="signupPassword" type="password" required>
      <div style="margin-top:12px">
        <button class="btn" type="submit">Cadastrar</button>
      </div>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = 'https://xqsuvwagygwkkugjqgpu.supabase.co';
    const SUPABASE_KEY = 'sb_publishable__lu67DW_OZJ_kbIw_aY3-Q_AI-DQvH1';

    if (!window.supabaseClient) {
      window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
    const supabase = window.supabaseClient;

    // Login
    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        alert('Erro: ' + error.message);
        return;
      }

      // update last_active
      const user = data.user;
      if (user) {
        await supabase.from('profiles').upsert({
          id: user.id,
          last_active: new Date().toISOString()
        }, { onConflict: 'id' }); // se perfil não existir, cria apenas last_active (nome pode ficar nulo)
      }

      // fetch role and redirect
      const { data: profile, error: pErr } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', user.id)
        .single();

      if (pErr) {
        console.error(pErr);
        alert('Erro ao buscar perfil');
        return;
      }

      if (profile && profile.role === 'admin') {
        window.location.href = 'admin.html';
      } else {
        alert('Login realizado com sucesso!');
        window.location.href = '/'; // volta para home
      }
    };

    // Signup (cria usuário e profile)
    document.getElementById('signupForm').onsubmit = async (e) => {
      e.preventDefault();
      const nome = document.getElementById('signupNome').value.trim();
      const dataNascimento = document.getElementById('signupNascimento').value;
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;

      // cria usuário no Auth
      const { data: signData, error: signErr } = await supabase.auth.signUp({
        email,
        password
      });

      if (signErr) {
        alert('Erro de cadastro: ' + signErr.message);
        return;
      }

      // signData.user pode ser nulo dependendo do fluxo de confirmação de e-mail.
      const user = signData.user;
      if (!user) {
        alert('Verifique seu e-mail para confirmar a conta. Depois faça login.');
        return;
      }

      // cria o perfil associado (id = auth user id)
      const { error: pErr } = await supabase.from('profiles').insert([{
        id: user.id,
        nome: nome,
        data_nascimento: dataNascimento,
        role: 'user',
        last_active: new Date().toISOString()
      }]);

      if (pErr) {
        console.error(pErr);
        alert('Erro ao criar perfil: veja o console.');
        return;
      }

      alert('Cadastro realizado! Você já está logado.');
      // redireciona para home
      window.location.href = '/';
    };
  </script>
</body>
</html>
