<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Loja Exemplo — Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Paleta azul */
      --bg:#06132a;            /* fundo geral */
      --card:#0b2033;          /* cartões */
      --muted:#9fb6d0;         /* texto secundário */
      --accent:#0b6fb6;        /* topbar / destaque */
      --accent-dark:#084f83;
      --btn-bg:linear-gradient(90deg,#1fb6ff,#3b82f6); /* botões */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg) 0%, #07132a 70%);color:#e6eef8;min-height:100vh;display:flex;flex-direction:column}
    /* Topbar estilo mercado livre-like (azul) */
    header.topbar{display:grid;grid-template-columns:240px 1fr 260px;gap:12px;align-items:center;padding:12px 20px;background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:#fff}
    .logo{background:rgba(255,255,255,0.06);color:#fff;width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800}
    .search{width:100%;padding:10px 14px;border-radius:6px;border:none;outline:none}
    .auth{display:flex;gap:12px;align-items:center;justify-content:flex-end}
    .auth a, .auth button{background:none;border:none;cursor:pointer;font-weight:700;color:#fff;text-decoration:none}
    .profileBtn{background:transparent;border:1px solid rgba(255,255,255,0.08);padding:8px 10px;border-radius:8px;display:flex;align-items:center;gap:8px;cursor:pointer;color:#fff}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:linear-gradient(180deg,#072033,#0b2436);color:#fff;border-radius:8px;min-width:180px;box-shadow:0 10px 30px rgba(0,0,0,0.35);overflow:hidden;display:none}
    .menu a, .menu button{display:block;padding:10px 12px;text-decoration:none;color:inherit;border:none;background:none;text-align:left;width:100%;cursor:pointer}
    .menu a:hover, .menu button:hover{background:rgba(255,255,255,0.03)}
    main{flex:1;padding:28px;display:flex;justify-content:center}
    .container{max-width:1200px;width:100%}
    .hero{display:grid;grid-template-columns:1fr 420px;gap:28px;align-items:center}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .newsletter{display:flex;gap:8px;margin-top:12px}
    .newsletter input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .btn-primary{background:var(--btn-bg);color:#061226;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    /* product grid */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:26px}
    .card-prod{background:#fff;padding:12px;border-radius:10px;color:#111}
    .card-prod img{width:100%;height:160px;object-fit:cover;border-radius:8px}
    footer{padding:18px 20px;color:var(--muted);background:transparent;border-top:1px solid rgba(255,255,255,0.03)}
    /* modal login */
    .modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;z-index:1200;padding:20px}
    .modal{width:420px;max-width:96vw;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:24px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(0,0,0,0.6);color:#e6eef8}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{flex:1;padding:8px 10px;border-radius:8px;text-align:center;cursor:pointer;font-weight:600;user-select:none;background:transparent}
    .tab.active{background:rgba(255,255,255,0.03)}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input[type="email"], input[type="password"], input[type="text"], input[type="date"]{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;margin-top:6px}
    .btn{margin-top:14px;width:100%;padding:10px;border-radius:10px;border:none;background:var(--btn-bg);color:#061226;font-weight:700;cursor:pointer}
    .small{font-size:13px;color:var(--muted);margin-top:10px;text-align:center}
    .link{color:#7dd3fc;cursor:pointer;text-decoration:underline}
    .errors{color:#ffb4b4;margin-top:8px;font-size:14px;display:none}
    @media(max-width:980px){ .hero{grid-template-columns:1fr} .grid{grid-template-columns:repeat(2,1fr)} header.topbar{grid-template-columns:1fr 1fr} .search{display:none} }
    @media(max-width:640px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>

  <header class="topbar" role="banner">
    <div style="display:flex;align-items:center;gap:12px">
      <div class="logo">LX</div>
      <div style="font-weight:800;color:#fff">Loja Exemplo</div>
    </div>

    <div>
      <input class="search" placeholder="Buscar produtos, marcas e muito mais..." aria-label="Buscar">
    </div>

    <div class="auth" id="authArea">
      <!-- estado para anon -->
      <div id="guestArea" style="display:flex;gap:10px;align-items:center">
        <!-- trocar para abrir modal -->
        <button id="createBtn">Criar conta</button>
        <button id="loginBtn">Entrar</button>
      </div>

      <!-- estado para usuario -->
      <div id="userArea" style="display:none;align-items:center">
        <div class="dropdown">
          <button id="profileBtn" class="profileBtn" aria-haspopup="true" aria-expanded="false">
            <span id="profileName">Usuário</span>
            <svg width="14" height="10" viewBox="0 0 24 24" fill="none" style="opacity:0.8"><path d="M6 9l6 6 6-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <div id="profileMenu" class="menu" role="menu" aria-hidden="true">
            <a id="myAccount" href="#">Minha conta</a>
            <a id="insightsLink" href="admin.html" style="display:none">Insights</a>
            <button id="logoutBtnMenu">Sair</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="hero">
        <div>
          <h1 style="color:#fff;margin:0 0 10px">Produtos que fazem a diferença — entregue rápido</h1>
          <p style="color:var(--muted);margin:0 0 12px">Design moderno, qualidade e preço justo. Veja ofertas e produtos antes de entrar.</p>

          <div class="card">
            <form id="newsletterForm" class="newsletter" onsubmit="subscribe(event)">
              <input id="newsletterEmail" type="email" placeholder="seu@exemplo.com" required>
              <button class="btn-primary" type="submit">Assinar</button>
            </form>
            <div id="newsletterMsg" style="color:var(--muted);margin-top:10px;font-size:14px"></div>
          </div>

          <section id="productsSection">
            <h2 style="color:#fff;margin-top:22px">Produtos em destaque</h2>
            <div class="grid" id="productsGrid">
              <!-- cards de exemplo -->
              <div class="card-prod"><img src="https://picsum.photos/seed/prod1/600/400" alt=""><h4>Tênis Urbano</h4><div style="font-weight:800">R$ 249,00</div></div>
              <div class="card-prod"><img src="https://picsum.photos/seed/prod2/600/400" alt=""><h4>Mochila Tech</h4><div style="font-weight:800">R$ 189,00</div></div>
              <div class="card-prod"><img src="https://picsum.photos/seed/prod3/600/400" alt=""><h4>Fone Wireless</h4><div style="font-weight:800">R$ 129,00</div></div>
            </div>
          </section>
        </div>

        <div class="card" aria-hidden="true" style="text-align:center">
          <img src="https://picsum.photos/seed/loja1/800/520" alt="Destaque" style="width:100%;border-radius:10px;display:block">
        </div>
      </div>
    </div>
  </main>

  <footer>
    © <span id="year"></span> Loja Exemplo — todos os direitos reservados
  </footer>

  <!-- Modal de login / signup (in-page) -->
  <div id="loginModal" class="modal-overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h2 id="modalTitle" style="margin:0 0 8px;font-size:20px">Entrar na Loja Exemplo</h2>
      <div class="tabs" role="tablist">
        <div id="modalTabLogin" class="tab active" role="tab" tabindex="0">Entrar</div>
        <div id="modalTabSignup" class="tab" role="tab" tabindex="0">Criar conta</div>
      </div>

      <!-- LOGIN -->
      <form id="modalLoginForm" autocomplete="on" novalidate>
        <label for="modalLoginEmail">E-mail</label>
        <input id="modalLoginEmail" type="email" required>
        <label for="modalLoginPassword">Senha</label>
        <input id="modalLoginPassword" type="password" required>
        <div id="modalLoginError" class="errors" role="alert"></div>
        <button class="btn" type="submit" id="modalLoginSubmit">Entrar</button>
        <div class="small">Ou <span id="modalOpenSignup" class="link">crie sua conta</span></div>
      </form>

      <!-- SIGNUP -->
      <form id="modalSignupForm" style="display:none" autocomplete="on" novalidate>
        <label for="modalSignupNome">Nome completo</label>
        <input id="modalSignupNome" type="text" required>
        <label for="modalSignupNascimento">Data de nascimento</label>
        <input id="modalSignupNascimento" type="date" required>
        <label for="modalSignupEmail">E-mail</label>
        <input id="modalSignupEmail" type="email" required>
        <label for="modalSignupPassword">Senha (mín 6 caracteres)</label>
        <input id="modalSignupPassword" type="password" minlength="6" required>
        <div id="modalSignupError" class="errors" role="alert"></div>
        <button class="btn" type="submit" id="modalSignupSubmit">Criar conta</button>
        <div class="small">Já tem conta? <span id="modalOpenLogin" class="link">Entrar</span></div>
      </form>
    </div>
  </div>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // config (mantive a sua url/key)
    const SUPABASE_URL = 'https://xqsuvwagygwkkugjqgpu.supabase.co';
    const SUPABASE_KEY = 'sb_publishable__lu67DW_OZJ_kbIw_aY3-Q_AI-DQvH1';

    if (!window.supabaseClient) {
      window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    }
    const supabase = window.supabaseClient;

    // UI refs
    const guestArea = document.getElementById('guestArea');
    const userArea = document.getElementById('userArea');
    const profileBtn = document.getElementById('profileBtn');
    const profileMenu = document.getElementById('profileMenu');
    const profileName = document.getElementById('profileName');
    const logoutBtnMenu = document.getElementById('logoutBtnMenu');
    const insightsLink = document.getElementById('insightsLink');

    // modal refs
    const loginModal = document.getElementById('loginModal');
    const modalTabLogin = document.getElementById('modalTabLogin');
    const modalTabSignup = document.getElementById('modalTabSignup');
    const modalLoginForm = document.getElementById('modalLoginForm');
    const modalSignupForm = document.getElementById('modalSignupForm');
    const modalOpenSignup = document.getElementById('modalOpenSignup');
    const modalOpenLogin = document.getElementById('modalOpenLogin');
    const createBtn = document.getElementById('createBtn');
    const loginBtn = document.getElementById('loginBtn');

    // show/hide modal
    function openModal(tab = 'login') {
      loginModal.style.display = 'flex';
      loginModal.setAttribute('aria-hidden','false');
      if (tab === 'signup') showModalSignup(); else showModalLogin();
      // trap focus simply by focusing first input
      setTimeout(() => {
        const first = document.querySelector('#loginModal input');
        if (first) first.focus();
      }, 100);
      document.body.style.overflow = 'hidden';
    }
    function closeModal() {
      loginModal.style.display = 'none';
      loginModal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }

    // tabs inside modal
    function showModalLogin() {
      modalTabLogin.classList.add('active');
      modalTabSignup.classList.remove('active');
      modalLoginForm.style.display = '';
      modalSignupForm.style.display = 'none';
      document.getElementById('modalLoginError').style.display = 'none';
      document.getElementById('modalSignupError').style.display = 'none';
    }
    function showModalSignup() {
      modalTabSignup.classList.add('active');
      modalTabLogin.classList.remove('active');
      modalLoginForm.style.display = 'none';
      modalSignupForm.style.display = '';
      document.getElementById('modalLoginError').style.display = 'none';
      document.getElementById('modalSignupError').style.display = 'none';
    }

    // hook modal openers
    createBtn.addEventListener('click', () => openModal('signup'));
    loginBtn.addEventListener('click', () => openModal('login'));
    modalTabLogin.addEventListener('click', showModalLogin);
    modalTabSignup.addEventListener('click', showModalSignup);
    modalOpenSignup.addEventListener('click', (e) => { e.preventDefault(); showModalSignup(); });
    modalOpenLogin.addEventListener('click', (e) => { e.preventDefault(); showModalLogin(); });

    // close modal when clicking outside
    loginModal.addEventListener('click', (e) => {
      if (e.target === loginModal) closeModal();
    });
    // close with ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && loginModal.style.display === 'flex') closeModal();
    });

    // dropdown profile toggle
    if (profileBtn) {
      profileBtn.addEventListener('click', () => {
        const shown = profileMenu.style.display === 'block';
        profileMenu.style.display = shown ? 'none' : 'block';
        profileBtn.setAttribute('aria-expanded', (!shown).toString());
      });
    }
    document.addEventListener('click', (e) => {
      if (!profileBtn?.contains(e.target) && !profileMenu?.contains(e.target)) {
        if (profileMenu) profileMenu.style.display = 'none';
        if (profileBtn) profileBtn.setAttribute('aria-expanded','false');
      }
    });

    logoutBtnMenu.addEventListener('click', async () => {
      await supabase.auth.signOut();
      await updateHeader();
    });

    // update header based on auth state
    async function updateHeader() {
      const { data } = await supabase.auth.getUser();
      const user = data.user ?? null;

      if (!user) {
        guestArea.style.display = 'flex';
        userArea.style.display = 'none';
        return;
      }

      // show user area and load profile
      guestArea.style.display = 'none';
      userArea.style.display = 'flex';

      const { data: profile, error } = await supabase
        .from('profiles')
        .select('nome, role')
        .eq('id', user.id)
        .single();

      profileName.textContent = (profile && profile.nome) ? profile.nome : (user.email || 'Usuário');

      // show Insights link only if role == 'admin'
      if (profile && profile.role === 'admin') {
        insightsLink.style.display = 'block';
      } else {
        insightsLink.style.display = 'none';
      }
    }

    // subscribe to auth changes
    supabase.auth.onAuthStateChange((_event, session) => {
      updateHeader();
      // if user logged in and modal open, close modal
      if (session?.user && loginModal.style.display === 'flex') closeModal();
    });

    // initial check
    (async () => { await updateHeader(); })();

    // modal: LOGIN handler
    modalLoginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const loginError = document.getElementById('modalLoginError');
      const email = document.getElementById('modalLoginEmail').value.trim();
      const password = document.getElementById('modalLoginPassword').value;

      const submit = document.getElementById('modalLoginSubmit');
      submit.disabled = true;
      submit.textContent = 'Entrando...';
      loginError.style.display = 'none';

      const { data, error } = await supabase.auth.signInWithPassword({email,password});
      if (error) {
        loginError.textContent = error.message || 'Erro ao logar';
        loginError.style.display = '';
        submit.disabled = false;
        submit.textContent = 'Entrar';
        return;
      }

      const user = data.user;
      if (user) {
        // upsert last_active and ensure profile exists
        await supabase.from('profiles').upsert([{
          id: user.id,
          last_active: new Date().toISOString()
        }], { onConflict: 'id' });

        await updateHeader();
        closeModal();
      } else {
        // Caso e-mail de confirmação: orientar
        alert('Verifique seu e-mail para confirmar a conta. Depois faça login.');
        closeModal();
      }
    });

    // modal: SIGNUP handler
    modalSignupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const signupError = document.getElementById('modalSignupError');
      const nome = document.getElementById('modalSignupNome').value.trim();
      const dataNascimento = document.getElementById('modalSignupNascimento').value;
      const email = document.getElementById('modalSignupEmail').value.trim();
      const password = document.getElementById('modalSignupPassword').value;

      const submit = document.getElementById('modalSignupSubmit');
      submit.disabled = true;
      submit.textContent = 'Criando...';
      signupError.style.display = 'none';

      const { data: signData, error: signErr } = await supabase.auth.signUp({ email, password });

      if (signErr) {
        signupError.textContent = signErr.message || 'Erro ao cadastrar';
        signupError.style.display = '';
        submit.disabled = false;
        submit.textContent = 'Criar conta';
        return;
      }

      const user = signData.user;
      if (user) {
        // create profile
        const { error: pErr } = await supabase.from('profiles').insert([{
          id: user.id,
          nome,
          data_nascimento: dataNascimento,
          role: 'user',
          last_active: new Date().toISOString()
        }]);

        if (pErr) {
          console.error(pErr);
          signupError.textContent = 'Erro ao criar perfil (veja console)';
          signupError.style.display = '';
          submit.disabled = false;
          submit.textContent = 'Criar conta';
          return;
        }

        await updateHeader();
        closeModal();
        return;
      }

      alert('Conta criada! Verifique seu e-mail para confirmar antes de entrar.');
      closeModal();
    });

    // newsletter behavior
    const newsletterForm = document.getElementById('newsletterForm');
    const newsletterMsg = document.getElementById('newsletterMsg');

    newsletterForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      newsletterMsg.textContent = '';
      const email = document.getElementById('newsletterEmail').value.trim();
      if (!email) { newsletterMsg.textContent = 'Informe um email válido.'; return; }

      const { error } = await supabase.from('respostas').insert([{ nome: 'Newsletter', email }]);
      if (error) {
        console.error(error);
        newsletterMsg.textContent = 'Erro ao salvar — veja console.';
      } else {
        newsletterMsg.textContent = 'Inscrição realizada com sucesso!';
        e.target.reset();
      }
    });

    // misc
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
